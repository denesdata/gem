<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EFC Radar Chart</title>
  <link rel="stylesheet" href="../base.css">
  <script src="../color-scheme.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    .chart-container {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .axis-label {
      font-size: 10px;
      fill: var(--text-secondary);
    }
    
    .axis-label:hover {
      fill: var(--primary);
      font-weight: 500;
    }
    
    .grid-circle {
      fill: none;
      stroke: var(--border);
      stroke-dasharray: 2,2;
    }
    
    .radar-area {
      fill-opacity: 0.3;
      stroke-width: 2;
      transition: fill-opacity 0.2s;
    }
    
    .radar-area:hover {
      fill-opacity: 0.5;
    }
    
    .radar-point {
      stroke-width: 2;
      stroke: var(--bg-card);
      transition: r 0.2s;
    }
    
    .radar-point:hover {
      r: 6;
    }
    
    .legend-container {
      position: absolute;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 24px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-secondary);
    }
    
    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }
  </style>
</head>
<body>
  <div class="chart-container" id="chart"></div>
  <div class="legend-container" id="legend"></div>

  <script>
    const dimensions = [
      { key: 'EFC1a', name: 'Finance' },
      { key: 'EFC2a', name: 'Gov Support' },
      { key: 'EFC3', name: 'Programs' },
      { key: 'EFC4b', name: 'Education' },
      { key: 'EFC5', name: 'R&D Transfer' },
      { key: 'EFC6', name: 'Infrastructure' },
      { key: 'EFC7b', name: 'Market Entry' },
      { key: 'EFC8', name: 'Physical' },
      { key: 'EFC9', name: 'Culture' }
    ];
    
    const datasets = [
      {
        name: 'Romania 2024',
        values: [4.2, 3.5, 4.0, 3.9, 3.4, 4.5, 4.1, 4.8, 3.6]
      },
      {
        name: 'EU Average',
        values: [4.5, 4.0, 4.3, 3.5, 3.8, 4.7, 4.3, 5.0, 4.0]
      }
    ];

    function render() {
      const container = document.getElementById('chart');
      const legendContainer = document.getElementById('legend');
      const colors = window.getGemColors();
      
      const rect = container.getBoundingClientRect();
      const size = Math.min(rect.width, rect.height) - 40;
      const radius = size / 2;
      const centerX = rect.width / 2;
      const centerY = rect.height / 2;
      const levels = 5;
      const maxValue = 5;
      
      container.innerHTML = '';
      
      const svg = d3.select('#chart')
        .append('svg')
        .attr('width', rect.width)
        .attr('height', rect.height);
      
      const g = svg.append('g')
        .attr('transform', `translate(${centerX}, ${centerY})`);
      
      // Grid circles
      for (let i = 1; i <= levels; i++) {
        g.append('circle')
          .attr('class', 'grid-circle')
          .attr('r', (radius / levels) * i);
      }
      
      // Axes
      const angleSlice = (Math.PI * 2) / dimensions.length;
      
      dimensions.forEach((dim, i) => {
        const angle = angleSlice * i - Math.PI / 2;
        const x = Math.cos(angle) * radius;
        const y = Math.sin(angle) * radius;
        
        g.append('line')
          .attr('x1', 0)
          .attr('y1', 0)
          .attr('x2', x)
          .attr('y2', y)
          .attr('stroke', 'var(--border)')
          .attr('stroke-opacity', 0.5);
        
        // Labels
        const labelRadius = radius + 20;
        const labelX = Math.cos(angle) * labelRadius;
        const labelY = Math.sin(angle) * labelRadius;
        
        g.append('text')
          .attr('class', 'axis-label')
          .attr('x', labelX)
          .attr('y', labelY)
          .attr('text-anchor', 'middle')
          .attr('dominant-baseline', 'middle')
          .text(dim.name);
      });
      
      // Radar areas
      datasets.forEach((dataset, dataIndex) => {
        const color = colors[dataIndex % colors.length];
        
        const lineGenerator = d3.lineRadial()
          .angle((d, i) => angleSlice * i - Math.PI / 2)
          .radius(d => (d / maxValue) * radius)
          .curve(d3.curveLinearClosed);
        
        g.append('path')
          .attr('class', 'radar-area')
          .attr('d', lineGenerator(dataset.values))
          .attr('fill', color)
          .attr('stroke', color);
        
        // Points
        dataset.values.forEach((value, i) => {
          const angle = angleSlice * i - Math.PI / 2;
          const x = Math.cos(angle) * (value / maxValue) * radius;
          const y = Math.sin(angle) * (value / maxValue) * radius;
          
          g.append('circle')
            .attr('class', 'radar-point')
            .attr('cx', x)
            .attr('cy', y)
            .attr('r', 4)
            .attr('fill', color);
        });
      });
      
      // Legend
      legendContainer.innerHTML = datasets.map((dataset, i) => `
        <div class="legend-item">
          <div class="legend-dot" style="background: ${colors[i % colors.length]}"></div>
          <span>${dataset.name}</span>
        </div>
      `).join('');
    }

    // Initialize - wait for color-scheme.js to be ready
    function init() {
      if (window.GEM && window.getGemColors) {
        render();
      } else {
        setTimeout(init, 50);
      }
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
    
    window.addEventListener('resize', render);
    window.addEventListener('gem-settings-change', render);
  </script>
</body>
</html>
